<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Management - OZON DETAILING</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="icon" href="images/transport.png">
    <style>
        /* YOUR ORIGINAL CSS - NO CHANGES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f6f9; color: #333; line-height: 1.6; }
        header { background-color: #2c3e50; color: white; padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 a { color: white; text-decoration: none; font-size: 1.8rem; }
        nav ul { list-style: none; display: flex; justify-content: flex-end; align-items: center; gap: 1.5rem; margin-top: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-size: 1rem; padding: 0.5rem 1rem; border-radius: 4px; }
        nav ul li a.active { background-color: #3498db; }
        #logout-link { color: #e74c3c; }
        main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        h2 { font-size: 2rem; margin-bottom: 1rem; color: #2c3e50; }
        #totals-area { display: flex; gap: 2rem; margin-bottom: 1.5rem; font-size: 1.1rem; }
        .filter-card { background-color: white; border-radius: 8px; padding: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin: 1rem 0; }
        #filters-area { display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: center; }
        #filters-area .form-group { display: flex; align-items: center; gap: 0.5rem; }
        #filters-area input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .message { padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; }
        .message-success { background-color: #d4edda; color: #155724; }
        .message-error { background-color: #f8d7da; color: #721c24; }
        table { width: 100%; border-collapse: collapse; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; }
        .number { text-align: right; font-family: monospace; }
        tbody tr:hover { background-color: #f1f3f5; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; }
        .modal-close { float: right; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .button { display: inline-block; padding: 0.5rem 1rem; background-color: #3498db; color: white; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
        .button-secondary { background-color: #7f8c8d; }
        .button-warning { background-color: #f39c12; }
        .button-danger { background-color: #e74c3c; }
        .button-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        footer { text-align: center; padding: 1rem; background-color: #2c3e50; color: white; margin-top: 2rem; }
        @media (max-width: 768px) {
            header, nav ul, #filters-area, #custom-date-range { flex-direction: column; align-items: flex-start; }
            #totals-area { flex-direction: column; gap: 0.5rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="dashboard.html">OZON DETAILING</a></h1>
        <nav>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="billing.html">Billing</a></li>
                <li><a href="stock.html">Stock</a></li>
                <li><a href="salary.html">Salaries</a></li>
                <li><a href="expenses.html">Expenses</a></li>
                <li><a href="purchases.html" class="active">Purchases</a></li>
                <li><a href="view_bills.html">View Bills</a></li>
                <li><a href="login.html" id="logout-link">Logout (<span id="logged-in-user"></span>)</a></li>
                <li><a href="productwarranty.html">productwarranty</a></li>
                      <li><a href="warrantypackage.html">warrantypackage</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="content-section">
            <div id="totals-area">
                <span>Total Paid: <span class="number" id="total-paid">₹0.00</span></span>
                <span>Total To Be Paid: <span class="number" id="total-to-be-paid">₹0.00</span></span>
            </div>
            <h2>Purchase Management</h2>
            <div id="message-area"></div>
            <button id="add-purchase-btn" class="button"><i class="fas fa-plus"></i> Add New Purchase</button>
            <div class="filter-card">
                <div id="filters-area">
                    <div class="form-group"><input type="text" id="search-input" placeholder="Search by item name..."></div>
                    <div class="form-group"><div class="radio-group">
                        <label><input type="radio" name="date-filter" value="all" checked> All</label>
                        <label><input type="radio" name="date-filter" value="today"> Today</label>
                        <label><input type="radio" name="date-filter" value="custom"> Custom</label>
                    </div></div>
                    <div class="form-group" id="custom-date-range" style="display: none;">
                        <input type="date" id="start-date"><label>to</label><input type="date" id="end-date">
                    </div>
                    <button id="clear-filters-btn" class="button button-secondary"><i class="fas fa-times"></i> Clear</button>
                </div>
            </div>
            <div style="overflow-x: auto; margin-top: 1.5rem;">
                <table>
                    <thead>
                        <tr><th>ID</th><th>Item Name</th><th>Qty</th><th>Unit</th><th>Per Unit Price</th><th>Paid</th><th>To Be Paid</th><th>Total</th><th>Date</th><th>Actions</th></tr>
                    </thead>
                    <tbody id="purchases-table-body"></tbody>
                </table>
            </div>
        </section>
        <div id="purchase-modal" class="modal">
            <div class="modal-content">
                <span class="modal-close" onclick="closeModal('purchase-modal')">&times;</span>
                <h3 id="purchase-modal-title">Add Purchase</h3>
                <form id="purchase-form">
                    <input type="hidden" id="purchase-id">
                    <div class="form-group"><label>Item Name *:</label><input type="text" id="item-name" required></div>
                    <div class="form-group"><label>Quantity *:</label><input type="number" id="quantity" step="0.01" min="0.01" required></div>
                    <div class="form-group"><label>Unit Type *:</label><select id="unit-type" required><option value="" disabled selected>Select</option><option value="kg">kg</option><option value="unit">unit</option></select></div>
                    <div class="form-group"><label>Per Unit Price (₹) *:</label><input type="number" id="per-unit-price" step="0.01" min="0" required></div>
                    <div class="form-group"><label>Paid (₹) *:</label><input type="number" id="paid-amount" step="0.01" min="0" required></div>
                    <div class="form-group"><label>To Be Paid (₹) *:</label><input type="number" id="to-be-paid" step="0.01" min="0" required></div>
                    <div class="form-group"><label>Purchase Date:</label><input type="date" id="purchase-date"></div>
                    <button type="submit" class="button"><i class="fas fa-save"></i> Save</button>
                </form>
            </div>
        </div>
    </main>
    <footer><p>© 2025 OZON DETAILING</p></footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
    <script>
        // ✅ CORRECT FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDZDRip0dEEFPC4h_FjG9_tJiZNcbK0fMo",
            authDomain: "cms-66a2b.firebaseapp.com",
            projectId: "cms-66a2b",
            databaseURL: "https://cms-66a2b-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "cms-66a2b.appspot.com",
            messagingSenderId: "628054355189",
            appId: "1:628054355189:web:4a977980fac4a1959829bc"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const purchasesRef = database.ref('purchases');

        let allPurchases = [];

        function showMessage(type, message) {
            const area = document.getElementById('message-area');
            if (area) area.innerHTML = `<div class="message message-${type}">${message}</div>`;
        }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) {
            const modal = document.getElementById(id);
            if(modal) modal.style.display = 'none';
            modal.querySelector('form')?.reset();
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('logged-in-user').textContent = localStorage.getItem('workshop_currentUser') || 'admin';
            const purchasesTableBody = document.getElementById('purchases-table-body');
            const purchaseForm = document.getElementById('purchase-form');
            const searchInput = document.getElementById('search-input');
            const dateFilters = document.querySelectorAll('input[name="date-filter"]');
            
            // --- Real-time Data Listener ---
            purchasesRef.on('value', snapshot => {
                const data = snapshot.val() || {};
                allPurchases = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                displayPurchases();
            });

            function displayPurchases() {
                const searchTerm = searchInput.value.toLowerCase();
                const dateFilter = document.querySelector('input[name="date-filter"]:checked').value;
                const startDate = document.getElementById('start-date').value;
                const endDate = document.getElementById('end-date').value;

                let filtered = allPurchases.filter(p => {
                    const searchMatch = p.itemName.toLowerCase().includes(searchTerm);
                    let dateMatch = true;
                    if (dateFilter === 'today') dateMatch = p.purchaseDate === new Date().toISOString().split('T')[0];
                    if (dateFilter === 'custom' && startDate && endDate) dateMatch = p.purchaseDate >= startDate && p.purchaseDate <= endDate;
                    return searchMatch && dateMatch;
                });
                
                filtered.sort((a,b) => new Date(b.purchaseDate) - new Date(a.purchaseDate));
                purchasesTableBody.innerHTML = '';
                let totalPaid = 0, totalToBePaid = 0;

                if(filtered.length === 0) {
                    purchasesTableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">No purchases found.</td></tr>';
                } else {
                    filtered.forEach(p => {
                        totalPaid += parseFloat(p.paidAmount) || 0;
                        totalToBePaid += parseFloat(p.toBePaid) || 0;
                        const total = (parseFloat(p.paidAmount) + parseFloat(p.toBePaid)).toFixed(2);
                        const row = purchasesTableBody.insertRow();
                        row.innerHTML = `
                            <td>${p.id}</td><td>${p.itemName}</td><td class="number">${p.quantity}</td>
                            <td>${p.unitType}</td><td class="number">${parseFloat(p.perUnitPrice).toFixed(2)}</td>
                            <td class="number">${parseFloat(p.paidAmount).toFixed(2)}</td><td class="number">${parseFloat(p.toBePaid).toFixed(2)}</td>
                            <td class="number">${total}</td><td>${p.purchaseDate || 'N/A'}</td>
                            <td><button class="button button-warning button-small" onclick="editPurchase('${p.id}')">Edit</button>
                                <button class="button button-danger button-small" onclick="deletePurchase('${p.id}')">Delete</button></td>`;
                    });
                }
                document.getElementById('total-paid').textContent = `₹${totalPaid.toFixed(2)}`;
                document.getElementById('total-to-be-paid').textContent = `₹${totalToBePaid.toFixed(2)}`;
            }
            
            // --- Event Listeners ---
            searchInput.addEventListener('input', displayPurchases);
            dateFilters.forEach(radio => radio.addEventListener('change', () => {
                document.getElementById('custom-date-range').style.display = radio.value === 'custom' ? 'flex' : 'none';
                displayPurchases();
            }));
            document.getElementById('start-date').addEventListener('change', displayPurchases);
            document.getElementById('end-date').addEventListener('change', displayPurchases);
            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                searchInput.value = '';
                document.querySelector('input[name="date-filter"][value="all"]').checked = true;
                document.getElementById('custom-date-range').style.display = 'none';
                displayPurchases();
            });

            document.getElementById('add-purchase-btn').onclick = () => {
                purchaseForm.reset();
                document.getElementById('purchase-id').value = '';
                document.getElementById('purchase-modal-title').textContent = 'Add Purchase';
                openModal('purchase-modal');
            };

            purchaseForm.addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('purchase-id').value;
                const purchaseId = id || purchasesRef.push().key;

                const data = {
                    itemName: document.getElementById('item-name').value,
                    quantity: parseFloat(document.getElementById('quantity').value),
                    unitType: document.getElementById('unit-type').value,
                    perUnitPrice: parseFloat(document.getElementById('per-unit-price').value),
                    paidAmount: parseFloat(document.getElementById('paid-amount').value),
                    toBePaid: parseFloat(document.getElementById('to-be-paid').value),
                    purchaseDate: document.getElementById('purchase-date').value || new Date().toISOString().split('T')[0]
                };

                purchasesRef.child(purchaseId).set(data).then(() => {
                    closeModal('purchase-modal');
                    showMessage('success', `Purchase ${id ? 'updated' : 'added'}!`);
                });
            });

            window.editPurchase = (id) => {
                const purchase = allPurchases.find(p => p.id === id);
                if (purchase) {
                    document.getElementById('purchase-modal-title').textContent = 'Edit Purchase';
                    document.getElementById('purchase-id').value = purchase.id;
                    Object.keys(purchase).forEach(key => {
                        const input = document.getElementById(key.replace('itemName', 'item-name').replace('unitType', 'unit-type').replace('perUnitPrice', 'per-unit-price').replace('paidAmount', 'paid-amount').replace('toBePaid', 'to-be-paid').replace('purchaseDate', 'purchase-date'));
                        if(input) input.value = purchase[key];
                    });
                    openModal('purchase-modal');
                }
            };
            
            window.deletePurchase = (id) => {
                if (confirm('Are you sure you want to delete this purchase record?')) {
                    purchasesRef.child(id).remove().then(() => showMessage('success', 'Purchase deleted.'));
                }
            };
        });
    </script>
</body>
</html>