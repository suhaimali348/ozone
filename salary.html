<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salary & Expense Management - OZON DETAILING</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="icon" href="images/transport.png">
    <style>
        /* YOUR ORIGINAL CSS - NO CHANGES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f6f9; color: #333; line-height: 1.6; }
        header { background-color: #2c3e50; color: white; padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); }
        header h1 a { color: white; text-decoration: none; font-size: 1.8rem; }
        nav ul { list-style: none; display: flex; justify-content: flex-end; align-items: center; gap: 1.5rem; margin-top: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-size: 1rem; padding: 0.5rem 1rem; border-radius: 4px; transition: background-color 0.3s; }
        nav ul li a:hover { background-color: #34495e; }
        nav ul li a.active { background-color: #3498db; }
        #logout-link { color: #e74c3c; }
        #logout-link:hover { background-color: #c0392b; }
        main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        main h2 { font-size: 2rem; margin-bottom: 1rem; color: #2c3e50; }
        .message { padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; }
        .message-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        table { width: 100%; border-collapse: collapse; background-color: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #eee; }
        th { background-color: #f8f9fa; font-weight: bold; }
        .action-buttons button, .main-action-buttons button { margin-right: 0.5rem; margin-bottom: 0.5rem; }
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 10% auto; padding: 2rem; border-radius: 8px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; }
        .modal-close { float: right; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.3rem; }
        .form-group input, .form-group select { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .button { display: inline-block; padding: 0.5rem 1rem; color: white; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
        .button-primary { background-color: #3498db; }
        .button-secondary { background-color: #7f8c8d; }
        .button-warning { background-color: #f39c12; }
        .button-danger { background-color: #e74c3c; }
        .button-success { background-color: #2ecc71; }
        .button-info { background-color: #17a2b8; }
        .button-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        footer { text-align: center; padding: 1rem; background-color: #2c3e50; color: white; margin-top: 2rem; }
        .category-group { display: flex; align-items: center; gap: 10px; }
        .category-list-container { max-height: 300px; overflow-y: auto; }
        .category-list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid #f0f0f0; }
        @media (max-width: 768px) {
            header, nav ul, .main-action-buttons { flex-direction: column; align-items: flex-start; }
            .main-action-buttons button { width: 100%; }
            table { font-size: 0.8rem; }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="dashboard.html">OZON DETAILING</a></h1>
        <nav>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="billing.html">Billing</a></li>
                <li><a href="stock.html">Stock</a></li>
                <li><a href="salary.html" class="active">Salaries</a></li>
                <li><a href="expenses.html">Expenses</a></li>
                <li><a href="view_bills.html">View Bills</a></li>
                <li><a href="login.html" id="logout-link">Logout (<span id="logged-in-user"></span>)</a></li>
                <li><a href="productwarranty.html">productwarranty</a></li>
                <li><a href="warrantypackage.html">warrantypackage</a></li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="content-section">
            <h2>Worker Salary Management</h2>
            <div id="message-area"></div>
            <div class="main-action-buttons">
                <button id="add-worker-btn" class="button"><i class="fas fa-user-plus"></i> Add New Worker</button>
                <button id="add-expense-btn" class="button button-success"><i class="fas fa-dollar-sign"></i> Add Expense</button>
                <button id="manage-categories-btn" class="button button-info"><i class="fas fa-tags"></i> Manage Categories</button>
                <button id="reset-borrowed-btn" class="button button-warning"><i class="fas fa-sync-alt"></i> Reset Borrowed</button>
            </div>
            <div style="overflow-x: auto; margin-top: 1.5rem;">
                <table>
                    <thead><tr><th>ID</th><th>Name</th><th>Position</th><th>Salary (₹)</th><th>Borrowed (₹)</th><th>Last Paid</th><th>Actions</th></tr></thead>
                    <tbody id="workers-table-body"></tbody>
                </table>
            </div>
        </section>

        <!-- Modals -->
        <div id="worker-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('worker-modal')">&times;</span><h3 id="worker-modal-title">Add Worker</h3><form id="worker-form"><input type="hidden" id="worker-id"><div class="form-group"><label for="worker-name">Name *:</label><input type="text" id="worker-name" required></div><div class="form-group"><label for="worker-position">Position *:</label><input type="text" id="worker-position" required></div><div class="form-group"><label for="worker-salary">Monthly Salary (₹) *:</label><input type="number" id="worker-salary" min="0" required></div><div class="form-group"><label for="worker-last-paid">Last Paid Date:</label><input type="date" id="worker-last-paid"></div><button type="submit" class="button">Save Worker</button></form></div></div>
        <div id="expense-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('expense-modal')">&times;</span><h3>Add Expense</h3><form id="expense-form"><div class="form-group"><label>Description *:</label><input type="text" id="expense-description" required></div><div class="form-group"><label>Amount (₹) *:</label><input type="number" id="expense-amount" min="0" required></div><div class="form-group"><label>Category *:</label><div class="category-group"><select id="expense-category-select" required></select><button type="button" id="open-add-category-modal-btn" class="button button-small">+</button></div></div><div class="form-group"><label>Date *:</label><input type="date" id="expense-date" required></div><button type="submit" class="button">Save Expense</button></form></div></div>
        <div id="add-category-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('add-category-modal')">&times;</span><h3 id="add-category-modal-title">Add Category</h3><form id="add-category-form"><input type="hidden" id="edit-category-id"><div class="form-group"><label>Category Name *:</label><input type="text" id="new-category-name" required></div><button type="submit" class="button">Save</button></form></div></div>
        <div id="manage-categories-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('manage-categories-modal')">&times;</span><h3>Manage Categories</h3><div class="category-list-container" id="category-list-display"></div><button type="button" class="button button-secondary" onclick="closeModal('manage-categories-modal')">Close</button></div></div>
        <div id="add-borrowed-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('add-borrowed-modal')">&times;</span><h3>Add Borrowed Money</h3><form id="add-borrowed-form"><input type="hidden" id="borrowed-worker-id"><div class="form-group"><label>Amount (₹) *:</label><input type="number" id="borrowed-amount" min="0" required></div><div class="form-group"><label>Date *:</label><input type="date" id="borrowed-date" required></div><button type="submit" class="button">Save</button></form></div></div>
        <div id="borrowing-history-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('borrowing-history-modal')">&times;</span><h3>Borrowing History</h3><table><thead><tr><th>Amount</th><th>Date</th><th>Actions</th></tr></thead><tbody id="borrowing-history-table-body"></tbody></table></div></div>
        <div id="last-paid-history-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('last-paid-history-modal')">&times;</span><h3>Last Paid History</h3><table><thead><tr><th>Amount</th><th>Date</th><th>Actions</th></tr></thead><tbody id="last-paid-history-table-body"></tbody></table></div></div>
        <div id="pay-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('pay-modal')">&times;</span><h3>Add Payment</h3><form id="pay-form"><input type="hidden" id="pay-worker-id"><div class="form-group"><label>Amount (₹) *:</label><input type="number" id="pay-amount" min="0" required></div><div class="form-group"><label>Date *:</label><input type="date" id="pay-date" required></div><button type="submit" class="button">Save</button></form></div></div>
        <div id="borrowing-reset-history-modal" class="modal"><div class="modal-content"><span class="modal-close" onclick="closeModal('borrowing-reset-history-modal')">&times;</span><h3>Borrowing Reset History</h3><table><thead><tr><th>Total Borrowed</th><th>Reset Date</th></tr></thead><tbody id="borrowing-reset-history-table-body"></tbody></table></div></div>
    </main>
    <footer><p>© 2025 OZON DETAILING</p></footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
    <script>
        // ✅ CORRECT FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDZDRip0dEEFPC4h_FjG9_tJiZNcbK0fMo",
            authDomain: "cms-66a2b.firebaseapp.com",
            projectId: "cms-66a2b",
            databaseURL: "https://cms-66a2b-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "cms-66a2b.appspot.com",
            messagingSenderId: "628054355189",
            appId: "1:628054355189:web:4a977980fac4a1959829bc"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const workersRef = database.ref('workers');
        const expensesRef = database.ref('expenses');
        const categoriesRef = database.ref('expense_categories');

        let allWorkers = [];

        function showMessage(type, message, areaId = 'message-area') {
            const area = document.getElementById(areaId);
            if (area) area.innerHTML = `<div class="message message-${type}">${message}</div>`;
        }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('logged-in-user').textContent = localStorage.getItem('workshop_currentUser') || 'admin';
            const workersTableBody = document.getElementById('workers-table-body');
            const workerForm = document.getElementById('worker-form');
            const expenseForm = document.getElementById('expense-form');
            const categoryForm = document.getElementById('add-category-form');
            const addBorrowedForm = document.getElementById('add-borrowed-form');
            const payForm = document.getElementById('pay-form');
            
            workersRef.on('value', snapshot => {
                const data = snapshot.val() || {};
                allWorkers = Object.entries(data).map(([id, val]) => ({ id, ...val }));
                displayWorkers();
            });
            
            categoriesRef.on('value', snapshot => {
                const categories = snapshot.val() || {};
                const dropdown = document.getElementById('expense-category-select');
                const manageList = document.getElementById('category-list-display');
                
                dropdown.innerHTML = '<option value="">-- Select --</option>';
                manageList.innerHTML = '';
                
                Object.entries(categories).forEach(([id, cat]) => {
                    dropdown.innerHTML += `<option value="${id}">${cat.name}</option>`;
                    manageList.innerHTML += `<div class="category-list-item"><span>${cat.name}</span><div>
                        <button class="button button-warning button-small" onclick="editCategory('${id}', '${cat.name}')"><i class="fas fa-edit"></i></button>
                        <button class="button button-danger button-small" onclick="deleteCategory('${id}')"><i class="fas fa-trash"></i></button>
                    </div></div>`;
                });
            });

            function displayWorkers() {
                workersTableBody.innerHTML = '';
                allWorkers.sort((a,b) => a.name.localeCompare(b.name));
                allWorkers.forEach(w => {
                    const borrowedTotal = w.borrowingHistory ? Object.values(w.borrowingHistory).reduce((sum, item) => sum + item.amount, 0) : 0;
                    const lastPaid = w.lastPaidHistory ? Object.values(w.lastPaidHistory).sort((a,b) => new Date(b.date) - new Date(a.date))[0]?.date : 'N/A';

                    const row = workersTableBody.insertRow();
                    row.innerHTML = `
                        <td>${w.id.substring(0, 6)}...</td><td>${w.name}</td><td>${w.position}</td>
                        <td class="number">${parseFloat(w.salary||0).toFixed(2)}</td>
                        <td class="number">${borrowedTotal.toFixed(2)}</td>
                        <td>${lastPaid !== 'N/A' ? new Date(lastPaid).toLocaleDateString('en-IN') : 'N/A'}</td>
                        <td class="action-buttons">
                            <button class="button button-info button-small" onclick="viewHistory('${w.id}', 'borrowing')">Borrowed</button>
                            <button class="button button-info button-small" onclick="viewHistory('${w.id}', 'paid')">Paid</button>
                            <button class="button button-success button-small" onclick="openPayModal('${w.id}')">Pay</button>
                            <button class="button button-warning button-small" onclick="openBorrowModal('${w.id}')">Borrow</button>
                            <button class="button button-secondary button-small" onclick="editWorker('${w.id}')">Edit</button>
                            <button class="button button-danger button-small" onclick="deleteWorker('${w.id}')">Delete</button>
                        </td>`;
                });
            }
            
            workerForm.addEventListener('submit', e => { /* Save/Update Worker Logic */
                e.preventDefault();
                const id = document.getElementById('worker-id').value || workersRef.push().key;
                const data = {
                    name: document.getElementById('worker-name').value,
                    position: document.getElementById('worker-position').value,
                    salary: parseFloat(document.getElementById('worker-salary').value),
                    lastPaid: document.getElementById('worker-last-paid').value || null
                };
                workersRef.child(id).update(data).then(() => closeModal('worker-modal'));
            });

            expenseForm.addEventListener('submit', e => { /* Save Expense Logic */
                e.preventDefault();
                const data = {
                    description: document.getElementById('expense-description').value,
                    amount: parseFloat(document.getElementById('expense-amount').value),
                    categoryId: document.getElementById('expense-category-select').value,
                    categoryName: document.getElementById('expense-category-select').selectedOptions[0].text,
                    date: document.getElementById('expense-date').value
                };
                expensesRef.push(data).then(() => closeModal('expense-modal'));
            });
            
            categoryForm.addEventListener('submit', e => { /* Save/Update Category Logic */
                e.preventDefault();
                const id = document.getElementById('edit-category-id').value || categoriesRef.push().key;
                const name = document.getElementById('new-category-name').value;
                categoriesRef.child(id).set({name}).then(() => closeModal('add-category-modal'));
            });
            
            addBorrowedForm.addEventListener('submit', e => { /* Save Borrowed Logic */
                e.preventDefault();
                const workerId = document.getElementById('borrowed-worker-id').value;
                const data = {
                    amount: parseFloat(document.getElementById('borrowed-amount').value),
                    date: document.getElementById('borrowed-date').value
                };
                workersRef.child(workerId).child('borrowingHistory').push(data).then(() => closeModal('add-borrowed-modal'));
            });

            payForm.addEventListener('submit', e => { /* Save Payment Logic */
                 e.preventDefault();
                const workerId = document.getElementById('pay-worker-id').value;
                const data = {
                    amount: parseFloat(document.getElementById('pay-amount').value),
                    date: document.getElementById('pay-date').value
                };
                workersRef.child(workerId).child('lastPaidHistory').push(data);
                workersRef.child(workerId).update({ lastPaid: data.date }).then(() => closeModal('pay-modal'));
            });
            
            document.getElementById('reset-borrowed-btn').onclick = () => {
                if(confirm("Reset all borrowed amounts to zero for all workers?")) {
                    workersRef.once('value', snapshot => {
                        const updates = {};
                        snapshot.forEach(childSnapshot => {
                            const worker = childSnapshot.val();
                            const borrowedTotal = worker.borrowingHistory ? Object.values(worker.borrowingHistory).reduce((s, i) => s + i.amount, 0) : 0;
                            if (borrowedTotal > 0) {
                                updates[`${childSnapshot.key}/borrowingHistory`] = null;
                                updates[`${childSnapshot.key}/borrowingResetHistory/${database.ref().push().key}`] = { totalBorrowed: borrowedTotal, resetDate: new Date().toISOString().split('T')[0] };
                            }
                        });
                        database.ref().update(updates);
                    });
                }
            };
            
            // --- UI Functions ---
            window.editWorker = id => {
                const worker = allWorkers.find(w => w.id === id);
                if(worker) {
                    document.getElementById('worker-id').value = worker.id;
                    document.getElementById('worker-name').value = worker.name;
                    document.getElementById('worker-position').value = worker.position;
                    document.getElementById('worker-salary').value = worker.salary;
                    document.getElementById('worker-last-paid').value = worker.lastPaid;
                    document.getElementById('worker-modal-title').textContent = 'Edit Worker';
                    openModal('worker-modal');
                }
            };
            window.deleteWorker = id => { if(confirm('Delete this worker?')) workersRef.child(id).remove(); };
            window.openBorrowModal = id => { document.getElementById('borrowed-worker-id').value = id; openModal('add-borrowed-modal'); };
            window.openPayModal = id => { document.getElementById('pay-worker-id').value = id; openModal('pay-modal'); };
            window.viewHistory = (id, type) => {
                const worker = allWorkers.find(w => w.id === id);
                const history = (type === 'borrowing' ? worker.borrowingHistory : worker.lastPaidHistory) || {};
                const tableBody = document.getElementById(`${type}-history-table-body`);
                tableBody.innerHTML = '';
                Object.entries(history).forEach(([key, item]) => {
                    tableBody.innerHTML += `<tr><td>${item.amount}</td><td>${item.date}</td><td>
                        <button class="button button-danger button-small" onclick="deleteHistoryItem('${id}','${type}','${key}')">X</button>
                    </td></tr>`;
                });
                openModal(`${type}-history-modal`);
            };
            window.deleteHistoryItem = (workerId, type, itemId) => {
                if(confirm('Delete this record?')) {
                    workersRef.child(workerId).child(`${type}History`).child(itemId).remove();
                }
            };
             window.editCategory = (id, name) => {
                document.getElementById('edit-category-id').value = id;
                document.getElementById('new-category-name').value = name;
                document.getElementById('add-category-modal-title').textContent = 'Edit Category';
                openModal('add-category-modal');
            };
            window.deleteCategory = id => { if(confirm('Delete this category?')) categoriesRef.child(id).remove(); };

            document.getElementById('add-worker-btn').onclick = () => openModal('worker-modal');
            document.getElementById('add-expense-btn').onclick = () => { document.getElementById('expense-date').valueAsDate = new Date(); openModal('expense-modal'); };
            document.getElementById('manage-categories-btn').onclick = () => openModal('manage-categories-modal');
            document.getElementById('open-add-category-modal-btn').onclick = () => openModal('add-category-modal');
        });
    </script>
</body>
</html>