<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bills - OZON DETAILING</title>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="icon" href="images/transport.png">
    <style>
        /* YOUR ORIGINAL CSS - NO CHANGES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #f4f6f9; color: #333; line-height: 1.6; }
        header { background-color: #2c3e50; color: white; padding: 1rem 2rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 a { color: white; text-decoration: none; font-size: 1.8rem; }
        nav ul { list-style: none; display: flex; justify-content: flex-end; align-items: center; gap: 1.5rem; margin-top: 0.5rem; }
        nav ul li a { color: white; text-decoration: none; font-size: 1rem; padding: 0.5rem 1rem; border-radius: 4px; }
        nav ul li a.active { background-color: #3498db; }
        #logout-link { color: #e74c3c; }
        main { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        h2 { font-size: 2rem; margin-bottom: 1rem; color: #2c3e50; }
        .todays-profit { background-color: #d4edda; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem; font-size: 1.2rem; color: #155724; text-align: center; }
        .payment-totals { background-color: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; justify-content: center; gap: 2rem; flex-wrap: wrap;}
        .message { padding: 1rem; border-radius: 4px; margin-bottom: 1.5rem; }
        .message-success { background-color: #d4edda; color: #155724; }
        .filter-controls { background-color: #e9ecef; padding: 1rem; border-radius: 8px; margin-bottom: 2rem; display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
        .filter-controls .form-group { flex: 1; min-width: 150px; }
        .filter-controls label { font-size: 0.9rem; margin-bottom: 0.3rem; display: block; }
        .filter-controls input { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
        .bill-summary { background-color: white; border-radius: 8px; margin-bottom: 1.5rem; padding: 1.5rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; }
        .bill-summary h3 { margin: 0 0 1rem; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .bill-count { position: absolute; top: 10px; left: 10px; background-color: #3498db; color: white; padding: 0.3rem 0.6rem; border-radius: 4px; font-size: 0.85rem; }
        .bill-details p { margin: 0.3rem 0; }
        .bill-items-table { width: 100%; margin-top: 1rem; border-collapse: collapse; }
        .bill-items-table th, .bill-items-table td { border: 1px solid #eee; padding: 0.5rem; }
        .bill-items-table th { background-color: #f8f9fa; }
        .bill-totals { margin-top: 1rem; text-align: right; }
        .button { display: inline-block; padding: 0.5rem 1rem; color: white; text-decoration: none; border: none; border-radius: 4px; cursor: pointer; }
        .button-primary { background-color: #3498db; }
        .button-secondary { background-color: #7f8c8d; }
        .button-danger { background-color: #e74c3c; }
        .button-success { background-color: #2ecc71; }
        .button-small { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
        button:disabled { opacity: 0.7; cursor: not-allowed; }
        .pdf-preview-modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); }
        .pdf-preview-content { background-color: #fefefe; margin: 2% auto; padding: 20px; width: 95%; max-width: 900px; height: 95%; position: relative; display: flex; flex-direction: column; }
        .pdf-preview-content iframe { width: 100%; flex-grow: 1; border: 1px solid #ccc; }
        .pdf-preview-close { color: #aaa; position: absolute; top: 5px; right: 15px; font-size: 32px; font-weight: bold; cursor: pointer; }
        footer { text-align: center; padding: 1rem; background-color: #2c3e50; color: white; margin-top: 2rem; }
        @media (max-width: 768px) {
            header, nav ul, .filter-controls, .payment-totals { flex-direction: column; align-items: flex-start; }
            .bill-summary h3 { flex-direction: column; }
        }
    </style>
</head>
<body>
    <header>
        <h1><a href="dashboard.html">OZON DETAILING</a></h1>
        <nav>
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="billing.html">Billing</a></li>
                <li><a href="stock.html">Stock</a></li>
                <li><a href="salary.html">Salaries</a></li>
                <li><a href="expenses.html">Expenses</a></li>
                <li><a href="view_bills.html" class="active">View Bills</a></li>
                <li><a href="warrantypackage.html">Warranty Packages</a></li>
                <li><a href="login.html" id="logout-link">Logout (<span id="logged-in-user"></span>)</a></li>
                   <li><a href="productwarranty.html">Warranty Packages</a>productwarranty</li>
                   <li><a href="warrantypackage.html">Warranty Packages</a>warrantypackage.html</li>
            </ul>
        </nav>
    </header>
    <main>
        <section class="content-section">
            <h2>View Saved Bills</h2>
            <div class="todays-profit" id="todays-profit">Today's Profit: ₹ 0.00</div>
            <div class="payment-totals">
                <span id="total-cash">Total Cash Payments: ₹ 0.00</span>
                <span id="total-online">Total Online Payments: ₹ 0.00</span>
            </div>
            <div id="message-area"></div>
            <div class="filter-controls">
                <div class="form-group"><label>From:</label><input type="date" id="filter_from_date"></div>
                <div class="form-group"><label>To:</label><input type="date" id="filter_to_date"></div>
                <button id="filter_apply_btn" class="button button-primary"><i class="fas fa-filter"></i> Apply</button>
                <button id="filter_today_btn" class="button button-secondary"><i class="fas fa-calendar-day"></i> Today</button>
                <button id="filter_month_btn" class="button button-secondary"><i class="fas fa-calendar-alt"></i> Month</button>
                <button id="filter_reset_btn" class="button button-secondary"><i class="fas fa-undo"></i> Reset</button>
            </div>
            <div id="bills-list"><p style="text-align:center;">Connecting to database...</p></div>
        </section>
    </main>
    <div id="pdf-preview-modal" class="pdf-preview-modal">
        <div class="pdf-preview-content">
            <span class="pdf-preview-close" id="pdf-preview-close-btn">&times;</span>
            <div id="pdf-preview-loading" style="text-align:center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading PDF...</div>
            <iframe id="pdf-preview-iframe" title="PDF Preview" style="display: none;"></iframe>
        </div>
    </div>
    <footer><p>© 2025 OZON DETAILING</p></footer>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
    <script>
        // ✅ CORRECT FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyDZDRip0dEEFPC4h_FjG9_tJiZNcbK0fMo",
            authDomain: "cms-66a2b.firebaseapp.com",
            projectId: "cms-66a2b",
            databaseURL: "https://cms-66a2b-default-rtdb.asia-southeast1.firebasedatabase.app",
            storageBucket: "cms-66a2b.appspot.com",
            messagingSenderId: "628054355189",
            appId: "1:628054355189:web:4a977980fac4a1959829bc"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const billsRef = database.ref('bills');
        const stockRef = database.ref('stock');

        let allBills = [];

        function showMessage(type, message) {
            const area = document.getElementById('message-area');
            if (area) area.innerHTML = `<div class="message message-${type}">${message}</div>`;
        }
        function formatDate(d) { return new Date(d).toISOString().split('T')[0]; }
        
        // ✅ YOUR ORIGINAL, PROFESSIONAL PDF DESIGN - RESTORED AND WORKING
        function generatePDFForBill(billData, outputType = 'download') { 
            return new Promise((resolve, reject) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const logoPath = 'https://res.cloudinary.com/dqqzpvrkw/image/upload/v1744718602/24x24_OZON-1_wef9pj.png';
                const img = new Image();
                img.crossOrigin = "Anonymous";
                
                const generateContent = () => {
                    const pageHeight = doc.internal.pageSize.height;
                    const pageWidth = doc.internal.pageSize.width;
                    const margin = 15;
                    let currentY = 20;

                    doc.setFontSize(22).setFont('helvetica', 'bold').setTextColor(44, 62, 80);
                    doc.text('INVOICE', pageWidth / 2, currentY, { align: 'center' });
                    currentY += 15;

                    doc.autoTable({
                        startY: currentY, theme: 'plain',
                        body: [
                            [{ content: 'FROM:', styles: { fontStyle: 'bold' } }, { content: 'BILL TO:', styles: { fontStyle: 'bold' } }],
                            [{ content: 'OZON DETAILING & CAR WASH\nKolathakkara, manipuram\nputhoor (po), omassery 673582\n+91-9447405746' }, { content: `${billData.customerName}\n${billData.customerMobile || ''}` }],
                        ],
                        columnStyles: { 0: { cellWidth: 85 }, 1: { cellWidth: 85 } }, margin: { left: margin }
                    });
                    currentY = doc.lastAutoTable.finalY + 10;

                    doc.autoTable({
                        startY: currentY, theme: 'plain',
                        body: [
                            [{ content: 'INVOICE #:', styles: { fontStyle: 'bold' } }, { content: billData.billId }, { content: 'VEHICLE:', styles: { fontStyle: 'bold' } }, { content: billData.carName }],
                            [{ content: 'DATE:', styles: { fontStyle: 'bold' } }, { content: new Date(billData.billDate).toLocaleDateString('en-IN') }, { content: 'REG. NO:', styles: { fontStyle: 'bold' } }, { content: billData.numberPlate }]
                        ],
                        columnStyles: { 0: { cellWidth: 25 }, 1: { cellWidth: 60 }, 2: { cellWidth: 25 }, 3: { cellWidth: 60 } }, margin: { left: margin }
                    });
                    currentY = doc.lastAutoTable.finalY + 10;

                    const tableBody = billData.items.map(item => [item.name, item.quantity, `₹${parseFloat(item.price||0).toFixed(2)}`, `₹${(item.quantity * (item.price||0)).toFixed(2)}`]);
                    doc.autoTable({
                        startY: currentY, head: [['ITEM DESCRIPTION', 'QTY', 'RATE', 'AMOUNT']], body: tableBody,
                        theme: 'striped', headStyles: { fillColor: [44, 62, 80] }, columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' }, 3: { halign: 'right' } }, margin: { left: margin, right: margin }
                    });
                    currentY = doc.lastAutoTable.finalY;

                    const totalsBody = [];
                    totalsBody.push(['Items Subtotal:', `₹${(billData.itemsSubtotal || 0).toFixed(2)}`]);
                    totalsBody.push(['Labour Cost:', `₹${(billData.labourCost || 0).toFixed(2)}`]);
                    totalsBody.push([{ content: 'TOTAL:', styles: { fontStyle: 'bold', fontSize: 12 } }, { content: `₹${(billData.totalAmount || 0).toFixed(2)}`, styles: { fontStyle: 'bold', fontSize: 12 } }]);
                    doc.autoTable({
                        startY: currentY + 5, theme: 'plain', body: totalsBody, tableWidth: 80,
                        margin: { left: pageWidth - margin - 80 }, columnStyles: { 0: { halign: 'left' }, 1: { halign: 'right' } }
                    });
                    
                    if (outputType === 'download') { doc.save(`Bill_${billData.billId}.pdf`); resolve(); } 
                    else { resolve(doc.output('bloburi')); }
                };
                
                img.onload = () => { doc.addImage(img, 'PNG', 15, 12, 25, 25); generateContent(); };
                img.onerror = () => { generateContent(); };
                img.src = logoPath;
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('logged-in-user').textContent = localStorage.getItem('workshop_currentUser') || 'admin';
            const billsListDiv = document.getElementById('bills-list');
            const fromDateInput = document.getElementById('filter_from_date');
            const toDateInput = document.getElementById('filter_to_date');
            
            billsRef.orderByChild('createdAt').on('value', snapshot => {
                const data = snapshot.val() || {};
                allBills = Object.values(data).reverse(); 
                displayBills(fromDateInput.value, toDateInput.value);
            });

            function displayBills(filterStartDate = null, filterEndDate = null) {
                let filteredBills = allBills;
                if (filterStartDate || filterEndDate) {
                    filteredBills = allBills.filter(bill => {
                        if (!bill.billDate) return false;
                        const billDate = new Date(bill.billDate);
                        const start = filterStartDate ? new Date(filterStartDate) : null;
                        const end = filterEndDate ? new Date(filterEndDate) : null;
                        return (!start || billDate >= start) && (!end || billDate <= end);
                    });
                }
                
                billsListDiv.innerHTML = filteredBills.length === 0 ? '<p style="text-align:center;">No bills found.</p>' : '';
                filteredBills.forEach((bill, index) => {
                    const billDiv = document.createElement('div');
                    billDiv.className = 'bill-summary';
                    const itemsTableHTML = bill.items && bill.items.length > 0 ? `<table class="bill-items-table"><thead><tr><th>Item</th><th>Code</th><th>Qty</th><th>Price</th><th>Total</th></tr></thead><tbody>${
                        bill.items.map(item => `<tr><td>${item.name}</td><td>${item.code||'N/A'}</td><td>${item.quantity}</td><td>${parseFloat(item.price||0).toFixed(2)}</td><td>${(item.quantity * (item.price||0)).toFixed(2)}</td></tr>`).join('')
                    }</tbody></table>` : '';
                    
                    billDiv.innerHTML = `
                        <div class="bill-count">#${filteredBills.length - index}</div>
                        <h3><span>Bill ID: ${bill.billId}</span><div class="bill-actions">
                            <button class="button button-success button-small" onclick="previewPdf('${bill.billId}')"><i class="fas fa-file-pdf"></i> Preview</button>
                            <button class="button button-secondary button-small" onclick="editBill('${bill.billId}')"><i class="fas fa-edit"></i> Edit</button>
                            <button class="button button-danger button-small" onclick="deleteBill('${bill.billId}')"><i class="fas fa-trash"></i> Delete</button>
                        </div></h3>
                        <div class="bill-details"><p><strong>Customer:</strong> ${bill.customerName}</p><p><strong>Date:</strong> ${new Date(bill.billDate).toLocaleDateString('en-IN')}</p></div>
                        ${itemsTableHTML}
                        <div class="bill-totals"><strong>Total: ₹ ${parseFloat(bill.totalAmount || 0).toFixed(2)}</strong></div>`;
                    billsListDiv.appendChild(billDiv);
                });
                calculateTotals(filteredBills);
            }
            
            function calculateTotals(bills) {
                 const todayStr = formatDate(new Date());
                 const todayProfit = allBills.filter(b => b.billDate === todayStr).reduce((sum, b) => sum + (b.cashPaid || 0) + (b.onlinePaid || 0), 0);
                 document.getElementById('todays-profit').textContent = `Today's Profit: ₹ ${todayProfit.toFixed(2)}`;
                 const totalCash = bills.reduce((sum, b) => sum + (b.cashPaid || 0), 0);
                 const totalOnline = bills.reduce((sum, b) => sum + (b.onlinePaid || 0), 0);
                 document.getElementById('total-cash').textContent = `Total Cash: ₹ ${totalCash.toFixed(2)}`;
                 document.getElementById('total-online').textContent = `Total Online: ₹ ${totalOnline.toFixed(2)}`;
            }

            document.getElementById('filter_apply_btn').onclick = () => displayBills(fromDateInput.value, toDateInput.value);
            document.getElementById('filter_today_btn').onclick = () => { const today = formatDate(new Date()); fromDateInput.value = today; toDateInput.value = today; displayBills(today, today); };
            document.getElementById('filter_month_btn').onclick = () => {
                const now = new Date(), firstDay = formatDate(new Date(now.getFullYear(), now.getMonth(), 1)), lastDay = formatDate(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                fromDateInput.value = firstDay; toDateInput.value = lastDay; displayBills(firstDay, lastDay);
            };
            document.getElementById('filter_reset_btn').onclick = () => { fromDateInput.value = ''; toDateInput.value = ''; displayBills(); };

            window.editBill = (billId) => { window.location.href = `billing.html?editId=${billId}`; };
            window.previewPdf = async (billId) => {
                const bill = allBills.find(b => b.billId === billId);
                if (bill) {
                    const modal = document.getElementById('pdf-preview-modal');
                    const iframe = document.getElementById('pdf-preview-iframe');
                    const loading = document.getElementById('pdf-preview-loading');
                    
                    iframe.style.display = 'none';
                    iframe.src = 'about:blank';
                    loading.style.display = 'block';
                    modal.style.display = 'flex';
                    
                    try {
                        const pdfUrl = await generatePDFForBill(bill, 'bloburi');
                        iframe.onload = () => {
                            loading.style.display = 'none';
                            iframe.style.display = 'block';
                        };
                        iframe.src = pdfUrl;
                    } catch (error) {
                        showMessage('error', 'Could not generate PDF preview.');
                        closeModal('pdf-preview-modal');
                    }
                }
            };
            document.getElementById('pdf-preview-close-btn').onclick = () => {
                document.getElementById('pdf-preview-modal').style.display = 'none';
                document.getElementById('pdf-preview-iframe').src = 'about:blank';
            };
            
            window.deleteBill = (billId) => {
                if (!confirm(`Delete Bill ${billId}? Stock will be restored.`)) return;
                billsRef.child(billId).once('value', snapshot => {
                    const billToDelete = snapshot.val();
                    if (!billToDelete) return showMessage('error', 'Bill not found.');
                    stockRef.transaction(stock => {
                        if (stock && billToDelete.items) {
                            billToDelete.items.forEach(item => { if (item.code && stock[item.code]) stock[item.code].quantity += item.quantity; });
                        }
                        return stock;
                    }, () => {
                        billsRef.child(billId).remove().then(() => showMessage('success', `Bill ${billId} deleted.`));
                    });
                });
            };
        });
    </script>
</body>
</html>